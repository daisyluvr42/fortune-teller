"""
å…«å­—å·¥å…·ç±» - åˆç›˜åˆ†æç­‰
"""


class BaziCompatibilityCalculator:
    """
    å…«å­—åˆç›˜è®¡ç®—å™¨ - åˆ†æä¸¤äººä¹‹é—´çš„"åŒ–å­¦ååº”"
    """
    
    def __init__(self):
        # å¤©å¹²äº”åˆ
        self.stem_combos = {
            frozenset(["ç”²", "å·±"]), frozenset(["ä¹™", "åºš"]), frozenset(["ä¸™", "è¾›"]),
            frozenset(["ä¸", "å£¬"]), frozenset(["æˆŠ", "ç™¸"])
        }
        # åœ°æ”¯å…­åˆ
        self.branch_combos = {
            frozenset(["å­", "ä¸‘"]), frozenset(["å¯…", "äº¥"]), frozenset(["å¯", "æˆŒ"]),
            frozenset(["è¾°", "é…‰"]), frozenset(["å·³", "ç”³"]), frozenset(["åˆ", "æœª"])
        }
        # åœ°æ”¯å…­å†²
        self.branch_clashes = {
            frozenset(["å­", "åˆ"]), frozenset(["ä¸‘", "æœª"]), frozenset(["å¯…", "ç”³"]),
            frozenset(["å¯", "é…‰"]), frozenset(["è¾°", "æˆŒ"]), frozenset(["å·³", "äº¥"])
        }

    def analyze_compatibility(self, person_a, person_b):
        """
        åˆ†æä¸¤äººå…«å­—çš„å…¼å®¹æ€§
        
        :param person_a: ç”²æ–¹å››æŸ±æ•°æ® (dict)
        :param person_b: ä¹™æ–¹å››æŸ±æ•°æ® (dict)
        :return: dict åŒ…å« details (åˆ†ææŠ¥å‘Šåˆ—è¡¨) å’Œ base_score (ç»¼åˆåˆ†æ•°)
        """
        report = []
        score_bonus = 0
        
        # 1. æ ¸å¿ƒï¼šæ—¥æŸ±å…³ç³» (å¤«å¦»å®«)
        # æ—¥å¹²å…³ç³»
        dm_a = person_a['day_pillar'][0]
        dm_b = person_b['day_pillar'][0]
        if frozenset([dm_a, dm_b]) in self.stem_combos:
            report.append(f"â¤ï¸ **æ—¥å¹²ç›¸åˆ ({dm_a}-{dm_b})**ï¼šçµé­‚å¸å¼•åŠ›æå¼ºï¼Œæ€§æ ¼äº’è¡¥ã€‚")
            score_bonus += 30
            
        # æ—¥æ”¯å…³ç³»
        db_a = person_a['day_pillar'][1]
        db_b = person_b['day_pillar'][1]
        if frozenset([db_a, db_b]) in self.branch_combos:
            report.append(f"ğŸ¤ **æ—¥æ”¯å…­åˆ ({db_a}-{db_b})**ï¼šç›¸å¤„èˆ’æœï¼Œç”Ÿæ´»æ­¥è°ƒä¸€è‡´ã€‚")
            score_bonus += 20
        elif frozenset([db_a, db_b]) in self.branch_clashes:
            report.append(f"âš¡ **æ—¥æ”¯ç›¸å†² ({db_a}-{db_b})**ï¼šå®¹æ˜“æœ‰ä»·å€¼è§‚å†²çªï¼Œéœ€ç£¨åˆã€‚")
            score_bonus -= 10

        # 2. äº”è¡Œäº’è¡¥ (ç®€å•çš„æ•°é‡äº’è¡¥é€»è¾‘)
        # å‡è®¾ person_a ç¼ºç«ï¼Œè€Œ person_b ç«å¤šï¼Œè¿™å°±æ˜¯äº’è¡¥
        # (è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œä»…ä½œé€»è¾‘ç¤ºä¾‹ï¼Œä½ éœ€è¦åŸºäºä½ çš„ count_wuxing å‡½æ•°)
        # if person_a['lacking'] == 'ç«' and person_b['strongest'] == 'ç«':
        #     report.append("ğŸ”¥ **äº”è¡Œäº’è¡¥**ï¼šå¯¹æ–¹çš„å¼ºé¡¹æ­£å¥½æ˜¯ä½ çš„å¼±é¡¹ï¼Œæ—ºä½ ã€‚")
        #     score_bonus += 20

        # 3. å¤©æ—‹åœ°å…‹ (å¹´æŸ±/æœˆæŸ±çš„å¤§å†²)
        # ... å¯ä»¥ç»§ç»­æ‰©å±• ...

        return {
            "details": report,
            "base_score": 60 + score_bonus  # åŸºç¡€åˆ†60
        }


def build_couple_prompt(person_a, person_b, comp_data, focus_instruction=""):
    """
    æ„å»ºåŒäººåˆç›˜çš„æœ€ç»ˆ Prompt
    
    :param person_a: ç”²æ–¹æ•°æ® (åŒ…å«å››æŸ±ã€æ ¼å±€ã€å¼ºå¼±ã€å–œç”¨ç¥)
    :param person_b: ä¹™æ–¹æ•°æ® (åŒ…å«å››æŸ±ã€æ ¼å±€ã€å¼ºå¼±ã€å–œç”¨ç¥)
    :param comp_data: Pythonç®—å‡ºçš„åˆç›˜ç¡¬æŒ‡æ ‡ (åŒ…å« 'details' åˆ—è¡¨, 'base_score' ç­‰)
    :param focus_instruction: ç”¨æˆ·çš„æ ¸å¿ƒè¯‰æ±‚ï¼Œå¦‚æœ‰åˆ™é‡ç‚¹å›ç­”
    """
    
    # å°† Python ç®—å‡ºçš„åˆ—è¡¨è½¬æ¢ä¸º Markdown æ–‡æœ¬
    hard_evidence = "\n".join([f"- {item}" for item in comp_data['details']])
    
    prompt = f"""
    # Role & Persona
    ä½ æ˜¯ä¸€ä½ç²¾é€šã€Šä¸‰å‘½é€šä¼šã€‹ä¸ç°ä»£å¿ƒç†å­¦çš„**èµ„æ·±æƒ…æ„Ÿå‘½ç†å¸ˆ**ã€‚
    ä½ ç°åœ¨çš„ä»»åŠ¡æ˜¯ä¸ºä¸¤ä½ç”¨æˆ·è¿›è¡Œã€åŒäººåˆç›˜æ·±åº¦åˆ†æã€‘ã€‚
    
    ---
    ### ğŸ“‚ æ¡£æ¡ˆèµ„æ–™ (System Verified Data)
    
    **ã€ç”²æ–¹ (User A)ã€‘**
    - **æ€§åˆ«**ï¼š{person_a.get('gender', 'æœªçŸ¥')}
    - **å…«å­—**ï¼š{person_a['year_pillar']}  {person_a['month_pillar']}  {person_a['day_pillar']}  {person_a['hour_pillar']}
    - **æ ¸å¿ƒæ ¼å±€**ï¼š{person_a.get('pattern_name', 'æ™®é€šæ ¼å±€')}
    - **äº”è¡Œèƒ½é‡**ï¼š{person_a.get('strength', 'æœªçŸ¥')} (å–œï¼š{person_a.get('joy_elements', 'æœªçŸ¥')})
    - **æœ¬å‘½ç”»åƒ**ï¼š(è¯·åŸºäºå…¶æ—¥ä¸»å’Œæ ¼å±€ï¼Œç”¨ä¸€å¥è¯æè¿°ç”²æ–¹çš„æ€§æ ¼åº•è‰²ï¼Œå¦‚"å›ºæ‰§ä½†æœ‰è´£ä»»æ„Ÿçš„ç£çŸ³")
    
    **ã€ä¹™æ–¹ (User B)ã€‘**
    - **æ€§åˆ«**ï¼š{person_b.get('gender', 'æœªçŸ¥')}
    - **å…«å­—**ï¼š{person_b['year_pillar']}  {person_b['month_pillar']}  {person_b['day_pillar']}  {person_b['hour_pillar']}
    - **æ ¸å¿ƒæ ¼å±€**ï¼š{person_b.get('pattern_name', 'æ™®é€šæ ¼å±€')}
    - **äº”è¡Œèƒ½é‡**ï¼š{person_b.get('strength', 'æœªçŸ¥')} (å–œï¼š{person_b.get('joy_elements', 'æœªçŸ¥')})
    - **æœ¬å‘½ç”»åƒ**ï¼š(è¯·åŸºäºå…¶æ—¥ä¸»å’Œæ ¼å±€ï¼Œç”¨ä¸€å¥è¯æè¿°ä¹™æ–¹çš„æ€§æ ¼åº•è‰²)

    ---
    ### ğŸ”— ç¼˜åˆ†ç¡¬æŒ‡æ ‡ (Python Calculated)
    **âš ï¸ ç³»ç»Ÿæ£€æµ‹åˆ°ä»¥ä¸‹å…³é”®åŒ–å­¦ååº”ï¼Œè¯·åŠ¡å¿…å°†å…¶ä½œä¸ºåˆ†æçš„æ ¸å¿ƒä¾æ®ï¼š**
    {hard_evidence}
    
    *(å¦‚æœæ­¤å¤„ä¸ºç©ºï¼Œä»£è¡¨ä¸¤äººå…«å­—æ— æ˜æ˜¾çš„å¼ºå†²æˆ–å¼ºåˆï¼Œå±äºå¹³æ·¡å…³ç³»ï¼Œè¯·æ®æ­¤åˆ†æ)*

    ---
    ### ğŸ¯ ç”¨æˆ·æ ¸å¿ƒè¯‰æ±‚ (User Focus)
    **ç”¨æˆ·ç°åœ¨çš„ç–‘é—®ç‚¹æ˜¯**ï¼š{focus_instruction if focus_instruction else "æ— ç‰¹åˆ«æŒ‡å®šï¼Œè¯·å…¨é¢åˆ†æ"}
    **æŒ‡ä»¤**ï¼š{'è¯·åœ¨åˆ†ææŠ¥å‘Šä¸­ï¼Œ**ç”¨ 50% ä»¥ä¸Šçš„ç¯‡å¹…** ä¸“é—¨å›ç­”è¿™ä¸ªé—®é¢˜ã€‚å…¶ä»–ç»´åº¦å¯ç®€ç•¥å¸¦è¿‡ã€‚' if focus_instruction else 'è¯·æŒ‰ç…§æ ‡å‡†ç»“æ„è¿›è¡Œå…¨é¢åˆ†æã€‚'}

    ---
    ### ğŸ“ åˆ†ææŒ‡ä»¤ (Instructions)
    
    è¯·æ’°å†™ä¸€ä»½**ã€ŠåŒäººçµé­‚å¥‘åˆåº¦æŠ¥å‘Šã€‹**ï¼Œè¯­æ°”è¦æ¸©æš–ã€å®¢è§‚ä¸”å…·æœ‰æ´å¯ŸåŠ›ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡º Markdownï¼š

    #### 1. ğŸ’‘ ç¼˜åˆ†æ€»è¯„ (The Metaphor)
    * ä¸è¦ç›´æ¥è¯´åˆ†æ•°ã€‚è¯·ç”¨ä¸€ä¸ª**è‡ªç„¶ç•Œçš„æ¯”å–»**æ¥å½¢å®¹è¿™æ®µå…³ç³»ã€‚
    * *ç¤ºä¾‹*ï¼š"ä½ ä»¬çš„å…³ç³»å°±åƒ**'è—¤è”“ç¼ ç»•å¤§æ ‘'**ï¼Œç”²æ–¹æä¾›äº†ç¨³å®šçš„ä¾é ï¼Œè€Œä¹™æ–¹å¸¦æ¥äº†ç”Ÿæœºä¸æƒ…æ„Ÿçš„æ»‹å…»ã€‚"
    * *é€»è¾‘å‚è€ƒ*ï¼šç»“åˆåŒæ–¹çš„èº«å¼ºèº«å¼±ï¼ˆå¦‚ä¸€å¼ºä¸€å¼±ä¸ºäº’è¡¥ï¼‰å’Œäº”è¡Œå–œå¿Œï¼ˆå¦‚äº’è¡¥åˆ™ä¸ºæ•‘èµï¼‰ã€‚

    #### 2. ğŸ§ª æ·±åº¦åŒ–å­¦ååº” (Interaction Analysis)
    * **æ€§æ ¼ç¢°æ’**ï¼šç»“åˆã€æ ¼å±€ã€‘åˆ†æã€‚ä¾‹å¦‚ï¼šä¸ƒæ€æ ¼ï¼ˆæ€¥èºï¼‰é‡åˆ°æ­£å°æ ¼ï¼ˆåŒ…å®¹ï¼‰ï¼Œæ˜¯è°åœ¨è¿å°±è°ï¼Ÿ
    * **ç¡¬æŒ‡æ ‡è§£è¯»**ï¼š**å¿…é¡»å¼•ç”¨**ä¸Šè¿°"ç¼˜åˆ†ç¡¬æŒ‡æ ‡"ä¸­çš„å†…å®¹ã€‚
        * å¦‚æœæœ‰**æ—¥æ”¯å…­åˆ**ï¼Œè¯·å¼ºè°ƒ"ç›¸å¤„é»˜å¥‘ï¼Œç”šè‡³ä¸ç”¨è¯´è¯å°±çŸ¥é“å¯¹æ–¹æƒ³ä»€ä¹ˆ"ã€‚
        * å¦‚æœæœ‰**æ—¥æ”¯ç›¸å†²**ï¼Œè¯·ç›´è¨€"å®¹æ˜“åœ¨ç”Ÿæ´»çäº‹ä¸Šä»·å€¼è§‚ä¸åŒ"ï¼Œå¹¶æŒ‡å‡ºå…·ä½“çš„å†²çªç‚¹ï¼ˆå¦‚ï¼šä¸€ä¸ªæƒ³å®‰ç¨³ï¼Œä¸€ä¸ªæƒ³æŠ˜è…¾ï¼‰ã€‚

    #### 3. âš ï¸ æ½œåœ¨é£é™©ä¸é›·åŒº (Risk Alert)
    * ä¸è¦åªè¯´å¥½è¯ã€‚è¯·æ•é”åœ°æŒ‡å‡ºä¸¤äººå…³ç³»ä¸­æœ€å¤§çš„éšæ‚£ã€‚
    * *ä¾‹å¦‚*ï¼šæµå¹´å†²å…‹ã€æ²Ÿé€šæ–¹å¼çš„å·®å¼‚ã€æˆ–è€…ä¸€æ–¹å¯¹å¦ä¸€æ–¹çš„è¿‡åº¦æ¶ˆè€—ã€‚

    #### 4. ğŸ’¡ ç»è¥å»ºè®® (Actionable Advice)
    * ç»™å‡º 2-3 æ¡å…·ä½“çš„ç›¸å¤„å»ºè®®ã€‚
    * **å¼€è¿å»ºè®®**ï¼šåŸºäºä¸¤äººçš„å–œç”¨ç¥ï¼Œæ¨èä¸€ä¸ªå…±åŒçš„æ´»åŠ¨ï¼ˆå¦‚ï¼šä¸¤äººéƒ½å–œç«ï¼Œå»ºè®®å¤šå»å—æ–¹æ—…æ¸¸æˆ–ä¸€èµ·éœ²è¥ï¼‰ã€‚

    ---
    **ç‰¹åˆ«ç¦å¿Œ**ï¼š
    1.  ä¸¥ç¦è¯´"ä½ ä»¬è‚¯å®šä¼šç¦»å©š"æˆ–"ä½ ä»¬æ³¨å®šåˆ†æ‰‹"ã€‚
    2.  é‡åˆ°åˆ‘å†²ï¼Œè¯·ç”¨"ç£¨åˆ"ã€"ä¿®ç‚¼"ç­‰è¯æ±‡ä»£æ›¿"å…‹æ­»"ã€‚
    3.  åˆ†æå¿…é¡»åŸºäºä¸Šè¿°æä¾›çš„å…«å­—æ•°æ®ï¼Œä¸å¯èƒ¡ç¼–ä¹±é€ ã€‚
    """
    
    return prompt
